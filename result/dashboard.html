
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Financial Calculations with Plotly</title>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f4f4f4;
                color: #333;
            }
            .menu {
                overflow: hidden;
                background-color: #333;
                padding: 0 10px;
            }
            .menu a {
                float: left;
                display: block;
                color: white;
                text-align: center;
                padding: 14px 16px;
                text-decoration: none;
            }
            .menu a:hover {
                background-color: #ddd;
                color: black;
            }
            .content {
                display: none;
                padding: 20px;
                background-color: white;
                margin: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            .content.active {
                display: block;
            }
            .chart-container {
                width: 100%;
                height: 400px;
                margin-top: 20px;
            }
            .input-group {
                margin: 10px 0;
                display: flex;
                align-items: center;
            }
            .input-group label {
                margin-right: 10px;
                flex: 1;
            }
            .input-group input {
                flex: 2;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            .input-group button {
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .input-group button:hover {
                background-color: #0056b3;
            }
            .metrics {
                margin-top: 20px;
                display: flex;
                flex-wrap: wrap;
            }
            .metrics div {
                flex: 1 1 200px;
                padding: 10px;
                margin: 5px;
                background-color: #f9f9f9;
                border: 1px solid #ccc;
                border-radius: 4px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="menu">
            <a href="#bessOptimizationResult" onclick="showSection('bessOptimizationResult')">Optimization Result for BESS Operation</a>
            <a href="#economicAnalysis" onclick="showSection('economicAnalysis')">Economic Analysis</a>
        </div>

        <div id="bessOptimizationResult" class="content">
            <h1>Optimization Result for BESS Operation</h1>
            <p>Optimization results for Battery Energy Storage System (BESS) operation will be displayed here, including price data, charging and discharging schedules, and state of charge over time.</p>
            <div class="chart-container" id="prices_chart"></div>
            <div class="chart-container" id="charge_discharge_chart"></div>
            <div class="chart-container" id="soc_chart"></div>
        </div>

        <div id="economicAnalysis" class="content">
            <h1>Economic Analysis</h1>
            <div class="input-group">
                <label for="discountRate">Discount Rate:</label>
                <input type="number" id="discountRate" name="discountRate" value="0.05" step="0.01" min="0" max="1" oninput="updateChart()">
            </div>
            <div class="input-group">
                <label for="annualCost">Annual Cost:</label>
                <input type="number" id="annualCost" name="annualCost" value="30" step="1" min="0" oninput="updateChart()">
            </div>
            <div class="input-group">
                <label for="initialCost">Initial Cost:</label>
                <input type="number" id="initialCost" name="initialCost" value="600" step="1" min="0" oninput="updateChart()">
            </div>
            <div class="input-group">
                <label for="annualRevenue">Annual Revenue:</label>
                <input type="number" id="annualRevenue" name="annualRevenue" value="279" step="1" min="0" oninput="updateChart()">
            </div>
            <div class="input-group">
                <label for="revenueChange">Annual Revenue Change (%):</label>
                <input type="number" id="revenueChange" name="revenueChange" value="0" step="1" min="-100" max="100" oninput="updateChart()">
            </div>
            <div class="input-group">
                <label for="costChange">Annual Cost Change (%):</label>
                <input type="number" id="costChange" name="costChange" value="0" step="1" min="-100" max="100" oninput="updateChart()">
            </div>
            <div class="input-group">
                <button onclick="resetDefaults()">Reset to Default Values</button>
            </div>

            <div class="metrics">
                <div>NPV: <span id="npvValue"></span></div>
                <div>BCR: <span id="bcrValue"></span></div>
                <div>ROI: <span id="roiValue"></span>%</div>
                <div>IRR: <span id="irrValue"></span>%</div>
            </div>

            <div class="chart-container" id="netCashFlowChart"></div>
            <div class="chart-container" id="cumulativeCashFlowChart"></div>
        </div>

        <script>
            const defaultValues = {
                discountRate: 0.05,
                annualCost: 30,
                initialCost: 600,
                annualRevenue: 279,
                revenueChange: 0,
                costChange: 0
            };

            var priceData = [{"time":"2024-01-01T00:00:00.000","arb_energy_price":100,"reg_up_price":50,"reg_down_price":25,"cres_capacity_price":75},{"time":"2024-01-01T01:00:00.000","arb_energy_price":101,"reg_up_price":51,"reg_down_price":26,"cres_capacity_price":76},{"time":"2024-01-01T02:00:00.000","arb_energy_price":102,"reg_up_price":52,"reg_down_price":27,"cres_capacity_price":77},{"time":"2024-01-01T03:00:00.000","arb_energy_price":103,"reg_up_price":53,"reg_down_price":28,"cres_capacity_price":78},{"time":"2024-01-01T04:00:00.000","arb_energy_price":104,"reg_up_price":54,"reg_down_price":29,"cres_capacity_price":79},{"time":"2024-01-01T05:00:00.000","arb_energy_price":105,"reg_up_price":55,"reg_down_price":30,"cres_capacity_price":80},{"time":"2024-01-01T06:00:00.000","arb_energy_price":106,"reg_up_price":56,"reg_down_price":31,"cres_capacity_price":81},{"time":"2024-01-01T07:00:00.000","arb_energy_price":107,"reg_up_price":57,"reg_down_price":32,"cres_capacity_price":82},{"time":"2024-01-01T08:00:00.000","arb_energy_price":108,"reg_up_price":58,"reg_down_price":33,"cres_capacity_price":83},{"time":"2024-01-01T09:00:00.000","arb_energy_price":109,"reg_up_price":59,"reg_down_price":34,"cres_capacity_price":84},{"time":"2024-01-01T10:00:00.000","arb_energy_price":110,"reg_up_price":60,"reg_down_price":35,"cres_capacity_price":85},{"time":"2024-01-01T11:00:00.000","arb_energy_price":111,"reg_up_price":61,"reg_down_price":36,"cres_capacity_price":86},{"time":"2024-01-01T12:00:00.000","arb_energy_price":112,"reg_up_price":62,"reg_down_price":37,"cres_capacity_price":87},{"time":"2024-01-01T13:00:00.000","arb_energy_price":113,"reg_up_price":63,"reg_down_price":38,"cres_capacity_price":88},{"time":"2024-01-01T14:00:00.000","arb_energy_price":114,"reg_up_price":64,"reg_down_price":39,"cres_capacity_price":89},{"time":"2024-01-01T15:00:00.000","arb_energy_price":115,"reg_up_price":65,"reg_down_price":40,"cres_capacity_price":90},{"time":"2024-01-01T16:00:00.000","arb_energy_price":116,"reg_up_price":66,"reg_down_price":41,"cres_capacity_price":91},{"time":"2024-01-01T17:00:00.000","arb_energy_price":117,"reg_up_price":67,"reg_down_price":42,"cres_capacity_price":92},{"time":"2024-01-01T18:00:00.000","arb_energy_price":118,"reg_up_price":68,"reg_down_price":43,"cres_capacity_price":93},{"time":"2024-01-01T19:00:00.000","arb_energy_price":119,"reg_up_price":69,"reg_down_price":44,"cres_capacity_price":94},{"time":"2024-01-01T20:00:00.000","arb_energy_price":120,"reg_up_price":70,"reg_down_price":45,"cres_capacity_price":95},{"time":"2024-01-01T21:00:00.000","arb_energy_price":121,"reg_up_price":71,"reg_down_price":46,"cres_capacity_price":96},{"time":"2024-01-01T22:00:00.000","arb_energy_price":122,"reg_up_price":72,"reg_down_price":47,"cres_capacity_price":97},{"time":"2024-01-01T23:00:00.000","arb_energy_price":123,"reg_up_price":73,"reg_down_price":48,"cres_capacity_price":98},{"time":"2024-01-02T00:00:00.000","arb_energy_price":124,"reg_up_price":74,"reg_down_price":49,"cres_capacity_price":99},{"time":"2024-01-02T01:00:00.000","arb_energy_price":125,"reg_up_price":75,"reg_down_price":50,"cres_capacity_price":100},{"time":"2024-01-02T02:00:00.000","arb_energy_price":126,"reg_up_price":76,"reg_down_price":51,"cres_capacity_price":101},{"time":"2024-01-02T03:00:00.000","arb_energy_price":127,"reg_up_price":77,"reg_down_price":52,"cres_capacity_price":102},{"time":"2024-01-02T04:00:00.000","arb_energy_price":128,"reg_up_price":78,"reg_down_price":53,"cres_capacity_price":103},{"time":"2024-01-02T05:00:00.000","arb_energy_price":129,"reg_up_price":79,"reg_down_price":54,"cres_capacity_price":104},{"time":"2024-01-02T06:00:00.000","arb_energy_price":130,"reg_up_price":80,"reg_down_price":55,"cres_capacity_price":105},{"time":"2024-01-02T07:00:00.000","arb_energy_price":131,"reg_up_price":81,"reg_down_price":56,"cres_capacity_price":106},{"time":"2024-01-02T08:00:00.000","arb_energy_price":132,"reg_up_price":82,"reg_down_price":57,"cres_capacity_price":107},{"time":"2024-01-02T09:00:00.000","arb_energy_price":133,"reg_up_price":83,"reg_down_price":58,"cres_capacity_price":108},{"time":"2024-01-02T10:00:00.000","arb_energy_price":134,"reg_up_price":84,"reg_down_price":59,"cres_capacity_price":109},{"time":"2024-01-02T11:00:00.000","arb_energy_price":135,"reg_up_price":85,"reg_down_price":60,"cres_capacity_price":110},{"time":"2024-01-02T12:00:00.000","arb_energy_price":136,"reg_up_price":86,"reg_down_price":61,"cres_capacity_price":111},{"time":"2024-01-02T13:00:00.000","arb_energy_price":137,"reg_up_price":87,"reg_down_price":62,"cres_capacity_price":112},{"time":"2024-01-02T14:00:00.000","arb_energy_price":138,"reg_up_price":88,"reg_down_price":63,"cres_capacity_price":113},{"time":"2024-01-02T15:00:00.000","arb_energy_price":139,"reg_up_price":89,"reg_down_price":64,"cres_capacity_price":114},{"time":"2024-01-02T16:00:00.000","arb_energy_price":140,"reg_up_price":90,"reg_down_price":65,"cres_capacity_price":115},{"time":"2024-01-02T17:00:00.000","arb_energy_price":141,"reg_up_price":91,"reg_down_price":66,"cres_capacity_price":116},{"time":"2024-01-02T18:00:00.000","arb_energy_price":142,"reg_up_price":92,"reg_down_price":67,"cres_capacity_price":117},{"time":"2024-01-02T19:00:00.000","arb_energy_price":143,"reg_up_price":93,"reg_down_price":68,"cres_capacity_price":118},{"time":"2024-01-02T20:00:00.000","arb_energy_price":144,"reg_up_price":94,"reg_down_price":69,"cres_capacity_price":119},{"time":"2024-01-02T21:00:00.000","arb_energy_price":145,"reg_up_price":95,"reg_down_price":70,"cres_capacity_price":120},{"time":"2024-01-02T22:00:00.000","arb_energy_price":146,"reg_up_price":96,"reg_down_price":71,"cres_capacity_price":121},{"time":"2024-01-02T23:00:00.000","arb_energy_price":147,"reg_up_price":97,"reg_down_price":72,"cres_capacity_price":122},{"time":"2024-01-03T00:00:00.000","arb_energy_price":148,"reg_up_price":98,"reg_down_price":73,"cres_capacity_price":123},{"time":"2024-01-03T01:00:00.000","arb_energy_price":149,"reg_up_price":99,"reg_down_price":74,"cres_capacity_price":124},{"time":"2024-01-03T02:00:00.000","arb_energy_price":150,"reg_up_price":100,"reg_down_price":75,"cres_capacity_price":125},{"time":"2024-01-03T03:00:00.000","arb_energy_price":151,"reg_up_price":101,"reg_down_price":76,"cres_capacity_price":126},{"time":"2024-01-03T04:00:00.000","arb_energy_price":152,"reg_up_price":102,"reg_down_price":77,"cres_capacity_price":127},{"time":"2024-01-03T05:00:00.000","arb_energy_price":153,"reg_up_price":103,"reg_down_price":78,"cres_capacity_price":128},{"time":"2024-01-03T06:00:00.000","arb_energy_price":154,"reg_up_price":104,"reg_down_price":79,"cres_capacity_price":129},{"time":"2024-01-03T07:00:00.000","arb_energy_price":155,"reg_up_price":105,"reg_down_price":80,"cres_capacity_price":130},{"time":"2024-01-03T08:00:00.000","arb_energy_price":156,"reg_up_price":106,"reg_down_price":81,"cres_capacity_price":131},{"time":"2024-01-03T09:00:00.000","arb_energy_price":157,"reg_up_price":107,"reg_down_price":82,"cres_capacity_price":132},{"time":"2024-01-03T10:00:00.000","arb_energy_price":158,"reg_up_price":108,"reg_down_price":83,"cres_capacity_price":133},{"time":"2024-01-03T11:00:00.000","arb_energy_price":159,"reg_up_price":109,"reg_down_price":84,"cres_capacity_price":134},{"time":"2024-01-03T12:00:00.000","arb_energy_price":160,"reg_up_price":110,"reg_down_price":85,"cres_capacity_price":135},{"time":"2024-01-03T13:00:00.000","arb_energy_price":161,"reg_up_price":111,"reg_down_price":86,"cres_capacity_price":136},{"time":"2024-01-03T14:00:00.000","arb_energy_price":162,"reg_up_price":112,"reg_down_price":87,"cres_capacity_price":137},{"time":"2024-01-03T15:00:00.000","arb_energy_price":163,"reg_up_price":113,"reg_down_price":88,"cres_capacity_price":138},{"time":"2024-01-03T16:00:00.000","arb_energy_price":164,"reg_up_price":114,"reg_down_price":89,"cres_capacity_price":139},{"time":"2024-01-03T17:00:00.000","arb_energy_price":165,"reg_up_price":115,"reg_down_price":90,"cres_capacity_price":140},{"time":"2024-01-03T18:00:00.000","arb_energy_price":166,"reg_up_price":116,"reg_down_price":91,"cres_capacity_price":141},{"time":"2024-01-03T19:00:00.000","arb_energy_price":167,"reg_up_price":117,"reg_down_price":92,"cres_capacity_price":142},{"time":"2024-01-03T20:00:00.000","arb_energy_price":168,"reg_up_price":118,"reg_down_price":93,"cres_capacity_price":143},{"time":"2024-01-03T21:00:00.000","arb_energy_price":169,"reg_up_price":119,"reg_down_price":94,"cres_capacity_price":144},{"time":"2024-01-03T22:00:00.000","arb_energy_price":170,"reg_up_price":120,"reg_down_price":95,"cres_capacity_price":145},{"time":"2024-01-03T23:00:00.000","arb_energy_price":171,"reg_up_price":121,"reg_down_price":96,"cres_capacity_price":146}];
            var resultData = [{"time":"2024-01-01T00:00:00.000","net_discharge":-50,"reg_up":-25,"reg_down":1,"cres":26,"soc_percent":0.5},{"time":"2024-01-01T01:00:00.000","net_discharge":-49,"reg_up":-24,"reg_down":2,"cres":27,"soc_percent":0.51},{"time":"2024-01-01T02:00:00.000","net_discharge":-48,"reg_up":-23,"reg_down":3,"cres":28,"soc_percent":0.52},{"time":"2024-01-01T03:00:00.000","net_discharge":-47,"reg_up":-22,"reg_down":4,"cres":29,"soc_percent":0.53},{"time":"2024-01-01T04:00:00.000","net_discharge":-46,"reg_up":-21,"reg_down":5,"cres":30,"soc_percent":0.54},{"time":"2024-01-01T05:00:00.000","net_discharge":-45,"reg_up":-20,"reg_down":6,"cres":31,"soc_percent":0.55},{"time":"2024-01-01T06:00:00.000","net_discharge":-44,"reg_up":-19,"reg_down":7,"cres":32,"soc_percent":0.56},{"time":"2024-01-01T07:00:00.000","net_discharge":-43,"reg_up":-18,"reg_down":8,"cres":33,"soc_percent":0.57},{"time":"2024-01-01T08:00:00.000","net_discharge":-42,"reg_up":-17,"reg_down":9,"cres":34,"soc_percent":0.58},{"time":"2024-01-01T09:00:00.000","net_discharge":-41,"reg_up":-16,"reg_down":10,"cres":35,"soc_percent":0.59},{"time":"2024-01-01T10:00:00.000","net_discharge":-40,"reg_up":-15,"reg_down":11,"cres":36,"soc_percent":0.6},{"time":"2024-01-01T11:00:00.000","net_discharge":-39,"reg_up":-14,"reg_down":12,"cres":37,"soc_percent":0.61},{"time":"2024-01-01T12:00:00.000","net_discharge":-38,"reg_up":-13,"reg_down":13,"cres":38,"soc_percent":0.62},{"time":"2024-01-01T13:00:00.000","net_discharge":-37,"reg_up":-12,"reg_down":14,"cres":39,"soc_percent":0.63},{"time":"2024-01-01T14:00:00.000","net_discharge":-36,"reg_up":-11,"reg_down":15,"cres":40,"soc_percent":0.64},{"time":"2024-01-01T15:00:00.000","net_discharge":-35,"reg_up":-10,"reg_down":16,"cres":41,"soc_percent":0.65},{"time":"2024-01-01T16:00:00.000","net_discharge":-34,"reg_up":-9,"reg_down":17,"cres":42,"soc_percent":0.66},{"time":"2024-01-01T17:00:00.000","net_discharge":-33,"reg_up":-8,"reg_down":18,"cres":43,"soc_percent":0.67},{"time":"2024-01-01T18:00:00.000","net_discharge":-32,"reg_up":-7,"reg_down":19,"cres":44,"soc_percent":0.68},{"time":"2024-01-01T19:00:00.000","net_discharge":-31,"reg_up":-6,"reg_down":20,"cres":45,"soc_percent":0.69},{"time":"2024-01-01T20:00:00.000","net_discharge":-30,"reg_up":-5,"reg_down":21,"cres":46,"soc_percent":0.7},{"time":"2024-01-01T21:00:00.000","net_discharge":-29,"reg_up":-4,"reg_down":22,"cres":47,"soc_percent":0.71},{"time":"2024-01-01T22:00:00.000","net_discharge":-28,"reg_up":-3,"reg_down":23,"cres":48,"soc_percent":0.72},{"time":"2024-01-01T23:00:00.000","net_discharge":-27,"reg_up":-2,"reg_down":24,"cres":49,"soc_percent":0.73},{"time":"2024-01-02T00:00:00.000","net_discharge":-26,"reg_up":-1,"reg_down":25,"cres":50,"soc_percent":0.74},{"time":"2024-01-02T01:00:00.000","net_discharge":-25,"reg_up":0,"reg_down":26,"cres":51,"soc_percent":0.75},{"time":"2024-01-02T02:00:00.000","net_discharge":-24,"reg_up":1,"reg_down":27,"cres":52,"soc_percent":0.76},{"time":"2024-01-02T03:00:00.000","net_discharge":-23,"reg_up":2,"reg_down":28,"cres":53,"soc_percent":0.77},{"time":"2024-01-02T04:00:00.000","net_discharge":-22,"reg_up":3,"reg_down":29,"cres":54,"soc_percent":0.78},{"time":"2024-01-02T05:00:00.000","net_discharge":-21,"reg_up":4,"reg_down":30,"cres":55,"soc_percent":0.79},{"time":"2024-01-02T06:00:00.000","net_discharge":-20,"reg_up":5,"reg_down":31,"cres":56,"soc_percent":0.8},{"time":"2024-01-02T07:00:00.000","net_discharge":-19,"reg_up":6,"reg_down":32,"cres":57,"soc_percent":0.81},{"time":"2024-01-02T08:00:00.000","net_discharge":-18,"reg_up":7,"reg_down":33,"cres":58,"soc_percent":0.82},{"time":"2024-01-02T09:00:00.000","net_discharge":-17,"reg_up":8,"reg_down":34,"cres":59,"soc_percent":0.83},{"time":"2024-01-02T10:00:00.000","net_discharge":-16,"reg_up":9,"reg_down":35,"cres":60,"soc_percent":0.84},{"time":"2024-01-02T11:00:00.000","net_discharge":-15,"reg_up":10,"reg_down":36,"cres":61,"soc_percent":0.85},{"time":"2024-01-02T12:00:00.000","net_discharge":-14,"reg_up":11,"reg_down":37,"cres":62,"soc_percent":0.86},{"time":"2024-01-02T13:00:00.000","net_discharge":-13,"reg_up":12,"reg_down":38,"cres":63,"soc_percent":0.87},{"time":"2024-01-02T14:00:00.000","net_discharge":-12,"reg_up":13,"reg_down":39,"cres":64,"soc_percent":0.88},{"time":"2024-01-02T15:00:00.000","net_discharge":-11,"reg_up":14,"reg_down":40,"cres":65,"soc_percent":0.89},{"time":"2024-01-02T16:00:00.000","net_discharge":-10,"reg_up":15,"reg_down":41,"cres":66,"soc_percent":0.9},{"time":"2024-01-02T17:00:00.000","net_discharge":-9,"reg_up":16,"reg_down":42,"cres":67,"soc_percent":0.91},{"time":"2024-01-02T18:00:00.000","net_discharge":-8,"reg_up":17,"reg_down":43,"cres":68,"soc_percent":0.92},{"time":"2024-01-02T19:00:00.000","net_discharge":-7,"reg_up":18,"reg_down":44,"cres":69,"soc_percent":0.93},{"time":"2024-01-02T20:00:00.000","net_discharge":-6,"reg_up":19,"reg_down":45,"cres":70,"soc_percent":0.94},{"time":"2024-01-02T21:00:00.000","net_discharge":-5,"reg_up":20,"reg_down":46,"cres":71,"soc_percent":0.95},{"time":"2024-01-02T22:00:00.000","net_discharge":-4,"reg_up":21,"reg_down":47,"cres":72,"soc_percent":0.96},{"time":"2024-01-02T23:00:00.000","net_discharge":-3,"reg_up":22,"reg_down":48,"cres":73,"soc_percent":0.97},{"time":"2024-01-03T00:00:00.000","net_discharge":-2,"reg_up":23,"reg_down":49,"cres":74,"soc_percent":0.98},{"time":"2024-01-03T01:00:00.000","net_discharge":-1,"reg_up":24,"reg_down":50,"cres":75,"soc_percent":0.99},{"time":"2024-01-03T02:00:00.000","net_discharge":0,"reg_up":25,"reg_down":51,"cres":76,"soc_percent":1.0},{"time":"2024-01-03T03:00:00.000","net_discharge":1,"reg_up":26,"reg_down":52,"cres":77,"soc_percent":1.01},{"time":"2024-01-03T04:00:00.000","net_discharge":2,"reg_up":27,"reg_down":53,"cres":78,"soc_percent":1.02},{"time":"2024-01-03T05:00:00.000","net_discharge":3,"reg_up":28,"reg_down":54,"cres":79,"soc_percent":1.03},{"time":"2024-01-03T06:00:00.000","net_discharge":4,"reg_up":29,"reg_down":55,"cres":80,"soc_percent":1.04},{"time":"2024-01-03T07:00:00.000","net_discharge":5,"reg_up":30,"reg_down":56,"cres":81,"soc_percent":1.05},{"time":"2024-01-03T08:00:00.000","net_discharge":6,"reg_up":31,"reg_down":57,"cres":82,"soc_percent":1.06},{"time":"2024-01-03T09:00:00.000","net_discharge":7,"reg_up":32,"reg_down":58,"cres":83,"soc_percent":1.07},{"time":"2024-01-03T10:00:00.000","net_discharge":8,"reg_up":33,"reg_down":59,"cres":84,"soc_percent":1.08},{"time":"2024-01-03T11:00:00.000","net_discharge":9,"reg_up":34,"reg_down":60,"cres":85,"soc_percent":1.09},{"time":"2024-01-03T12:00:00.000","net_discharge":10,"reg_up":35,"reg_down":61,"cres":86,"soc_percent":1.1},{"time":"2024-01-03T13:00:00.000","net_discharge":11,"reg_up":36,"reg_down":62,"cres":87,"soc_percent":1.11},{"time":"2024-01-03T14:00:00.000","net_discharge":12,"reg_up":37,"reg_down":63,"cres":88,"soc_percent":1.12},{"time":"2024-01-03T15:00:00.000","net_discharge":13,"reg_up":38,"reg_down":64,"cres":89,"soc_percent":1.13},{"time":"2024-01-03T16:00:00.000","net_discharge":14,"reg_up":39,"reg_down":65,"cres":90,"soc_percent":1.14},{"time":"2024-01-03T17:00:00.000","net_discharge":15,"reg_up":40,"reg_down":66,"cres":91,"soc_percent":1.15},{"time":"2024-01-03T18:00:00.000","net_discharge":16,"reg_up":41,"reg_down":67,"cres":92,"soc_percent":1.16},{"time":"2024-01-03T19:00:00.000","net_discharge":17,"reg_up":42,"reg_down":68,"cres":93,"soc_percent":1.17},{"time":"2024-01-03T20:00:00.000","net_discharge":18,"reg_up":43,"reg_down":69,"cres":94,"soc_percent":1.18},{"time":"2024-01-03T21:00:00.000","net_discharge":19,"reg_up":44,"reg_down":70,"cres":95,"soc_percent":1.19},{"time":"2024-01-03T22:00:00.000","net_discharge":20,"reg_up":45,"reg_down":71,"cres":96,"soc_percent":1.2},{"time":"2024-01-03T23:00:00.000","net_discharge":21,"reg_up":46,"reg_down":72,"cres":97,"soc_percent":1.21}];

            priceData.forEach(function(d) {
                d.time = new Date(d.time);
            });

            resultData.forEach(function(d) {
                d.time = new Date(d.time);
            });

            // Prices Chart
            Plotly.newPlot('prices_chart', [
                {
                    x: priceData.map(item => item.time),
                    y: priceData.map(item => item.arb_energy_price),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Arb Energy Price'
                },
                {
                    x: priceData.map(item => item.time),
                    y: priceData.map(item => item.reg_up_price),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Reg Up Price'
                },
                {
                    x: priceData.map(item => item.time),
                    y: priceData.map(item => item.reg_down_price),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Reg Down Price'
                },
                {
                    x: priceData.map(item => item.time),
                    y: priceData.map(item => item.cres_capacity_price),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'CRES Capacity Price'
                }
            ], {
                title: 'Energy Prices Over Time',
                xaxis: {title: 'Time'},
                yaxis: {title: 'Price ($)'},
                legend: { orientation: "h", y: 1.2 }
            }, 
            {responsive: true});

            // Charge Discharge Chart
            Plotly.newPlot('charge_discharge_chart', [
                {
                    x: resultData.map(item => item.time),
                    y: resultData.map(item => item.net_discharge),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Net Discharge'
                },
                {
                    x: resultData.map(item => item.time),
                    y: resultData.map(item => item.reg_up),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Reg Up'
                },
                {
                    x: resultData.map(item => item.time),
                    y: resultData.map(item => item.reg_down),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Reg Down'
                },
                {
                    x: resultData.map(item => item.time),
                    y: resultData.map(item => item.cres),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'CRES'
                }
            ], {
                title: 'Charging and Discharging Schedule',
                xaxis: {title: 'Time'},
                yaxis: {title: 'Power (MW)'},
                legend: { orientation: "h", y: 1.2 }
            }, 
            {responsive: true});

            // SOC Chart
            Plotly.newPlot('soc_chart', [
                {
                    x: resultData.map(item => item.time),
                    y: resultData.map(item => item.soc_percent * 100),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'State of Charge'
                }
            ], {
                title: 'State of Charge Over Time',
                xaxis: {title: 'Time'},
                yaxis: {title: 'SOC (%)'},
                legend: { orientation: "h", y: 1.2 }
            }, 
            {responsive: true});

            function showSection(sectionId) {
                var sections = document.querySelectorAll('.content');
                sections.forEach(function(section) {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                window.dispatchEvent(new Event('resize')); // Trigger resize to adjust Plotly charts
            }

            function resetDefaults() {
                document.getElementById('discountRate').value = defaultValues.discountRate;
                document.getElementById('annualCost').value = defaultValues.annualCost;
                document.getElementById('initialCost').value = defaultValues.initialCost;
                document.getElementById('annualRevenue').value = defaultValues.annualRevenue;
                document.getElementById('revenueChange').value = defaultValues.revenueChange;
                document.getElementById('costChange').value = defaultValues.costChange;
                updateChart();
            }

            function calculateIRR(values) {
                const guess = 0.1;
                const tol = 1e-6;
                const maxIter = 100;
                let rate = guess;
                for (let i = 0; i < maxIter; i++) {
                    let npv = values.reduce((acc, val, j) => acc + val / Math.pow(1 + rate, j), 0);
                    let npvPrime = values.reduce((acc, val, j) => acc - (j * val) / Math.pow(1 + rate, j + 1), 0);
                    let newRate = rate - npv / npvPrime;
                    if (Math.abs(newRate - rate) < tol) return newRate;
                    rate = newRate;
                }
                return rate;
            }

            function calculateFinancialMetrics(discountRate, initialCost, annualCost, annualRevenue, revenueChange, costChange) {
                let periods = Array.from({ length: 21 }, (_, i) => i);
                let cashInflows = [0].concat(Array(20).fill(annualRevenue).map((rev, i) => rev * Math.pow(1 + revenueChange / 100, i)));
                let cashOutflows = [initialCost].concat(Array(20).fill(annualCost).map((cost, i) => cost * Math.pow(1 + costChange / 100, i)));

                let netCashFlow = cashInflows.map((inflow, i) => inflow - cashOutflows[i]);
                let discountedNetCashFlow = netCashFlow.map((flow, i) => flow / Math.pow(1 + discountRate, periods[i]));
                let cumulativeNetCashFlow = netCashFlow.reduce((acc, val, i) => [...acc, (acc[i - 1] || 0) + val], []);
                let cumulativeDiscountedCashFlow = discountedNetCashFlow.reduce((acc, val, i) => [...acc, (acc[i - 1] || 0) + val], []);

                let totalPvInflows = cashInflows.reduce((acc, val, i) => acc + val / Math.pow(1 + discountRate, i), 0);
                let totalPvOutflows = cashOutflows.reduce((acc, val, i) => acc + val / Math.pow(1 + discountRate, i), 0);

                let npv = cumulativeDiscountedCashFlow[cumulativeDiscountedCashFlow.length - 1];
                let bcr = totalPvInflows / totalPvOutflows;
                let roi = ((totalPvInflows - totalPvOutflows) / totalPvOutflows) * 100;
                let irr = calculateIRR(netCashFlow) * 100;

                document.getElementById('npvValue').innerText = npv.toFixed(2);
                document.getElementById('bcrValue').innerText = bcr.toFixed(2);
                document.getElementById('roiValue').innerText = roi.toFixed(2);
                document.getElementById('irrValue').innerText = irr.toFixed(2);

                return {
                    periods,
                    cashInflows,
                    cashOutflows,
                    netCashFlow,
                    cumulativeNetCashFlow,
                    cumulativeDiscountedCashFlow
                };
            }

            function updateChart() {
                let discountRate = parseFloat(document.getElementById('discountRate').value);
                let initialCost = parseFloat(document.getElementById('initialCost').value);
                let annualCost = parseFloat(document.getElementById('annualCost').value);
                let annualRevenue = parseFloat(document.getElementById('annualRevenue').value);
                let revenueChange = parseFloat(document.getElementById('revenueChange').value);
                let costChange = parseFloat(document.getElementById('costChange').value);

                let metrics = calculateFinancialMetrics(discountRate, initialCost, annualCost, annualRevenue, revenueChange, costChange);

                let cashInflowsTrace = {
                    x: metrics.periods,
                    y: metrics.cashInflows,
                    name: 'Annual Revenue',
                    type: 'bar'
                };

                let cashOutflowsTrace = {
                    x: metrics.periods,
                    y: metrics.cashOutflows,
                    name: 'Annual Cost',
                    type: 'bar'
                };

                let netCashFlowTrace = {
                    x: metrics.periods,
                    y: metrics.netCashFlow,
                    name: 'Net Cash Flow',
                    type: 'scatter',
                    mode: 'lines+markers'
                };

                let cumulativeNetCashFlowTrace = {
                    x: metrics.periods,
                    y: metrics.cumulativeNetCashFlow,
                    name: 'Undiscounted Cumulative Cash Flow',
                    type: 'scatter',
                    mode: 'lines+markers'
                };

                let cumulativeDiscountedCashFlowTrace = {
                    x: metrics.periods,
                    y: metrics.cumulativeDiscountedCashFlow,
                    name: 'Discounted Cumulative Cash Flow',
                    type: 'scatter',
                    mode: 'lines+markers'
                };

                let netCashFlowData = [cashInflowsTrace, cashOutflowsTrace, netCashFlowTrace];
                let cumulativeCashFlowData = [cumulativeNetCashFlowTrace, cumulativeDiscountedCashFlowTrace];

                let netCashFlowLayout = {
                    title: 'Net Cash Flow with Annual Costs and Revenues',
                    xaxis: { title: 'Period' },
                    yaxis: { title: 'Amount' },
                    barmode: 'group',
                    legend: { orientation: "h", y: 1.2 }
                };

                let cumulativeCashFlowLayout = {
                    title: 'Cumulative Cash Flows',
                    xaxis: { title: 'Period' },
                    yaxis: { title: 'Amount' },
                    legend: { orientation: "h", y: 1.2 }
                };

                Plotly.newPlot('netCashFlowChart', netCashFlowData, netCashFlowLayout, {responsive: true});
                Plotly.newPlot('cumulativeCashFlowChart', cumulativeCashFlowData, cumulativeCashFlowLayout, {responsive: true});
            }

            showSection('bessOptimizationResult'); // Show the first section by default
            updateChart();
        </script>
    </body>
    </html>
    